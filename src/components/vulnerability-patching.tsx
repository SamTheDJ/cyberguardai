"use client";

import { useState } from "react";
import {
  Code2,
  ShieldCheck,
  AlertOctagon,
  Wrench,
  Loader2,
  Sparkles,
  GitMerge,
  ShieldQuestion
} from "lucide-react";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { SectionHeading } from "@/components/section-heading";
import { CodeBlock } from "@/components/code-block";
import { vulnerabilities, type Vulnerability } from "@/lib/data";
import { generatePatch, getPatchReasoning } from "@/app/actions";
import { useToast } from "@/hooks/use-toast";
import type { GenerateSecurityPatchOutput } from "@/ai/flows/generate-security-patch";
import type { ReasoningForPatchOutput } from "@/ai/flows/reasoning-for-patch";

export function VulnerabilityPatching() {
  const [vulns, setVulns] = useState<Vulnerability[]>(vulnerabilities);
  const [activeVulnId, setActiveVulnId] = useState<string | null>(null);
  const [patchResult, setPatchResult] = useState<GenerateSecurityPatchOutput | null>(null);
  const [reasoningResult, setReasoningResult] = useState<ReasoningForPatchOutput | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isReasoning, setIsReasoning] = useState(false);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const { toast } = useToast();

  const handleGeneratePatch = async (vuln: Vulnerability) => {
    setIsGenerating(true);
    setPatchResult(null);
    try {
      const result = await generatePatch(vuln);
      setPatchResult(result);
      toast({
        title: "AI Patch Generated",
        description: "Review the proposed fix and deploy.",
      });
    } catch (error) {
      toast({ variant: "destructive", title: "Patch Generation Failed" });
    } finally {
      setIsGenerating(false);
    }
  };

  const handleReviewPatch = async (vuln: Vulnerability) => {
    if (!patchResult) return;
    setActiveVulnId(vuln.id);
    setIsDialogOpen(true);
    setIsReasoning(true);
    try {
        const result = await getPatchReasoning(vuln, patchResult.patchCode);
        setReasoningResult(result);
    } catch(error) {
        toast({ variant: "destructive", title: "Patch Review Failed" });
        setIsDialogOpen(false);
    } finally {
        setIsReasoning(false);
    }
  }

  const handleDeploy = () => {
    if(!activeVulnId) return;
    setVulns(vulns.map(v => v.id === activeVulnId ? {...v, status: 'Patched'} : v));
    setIsDialogOpen(false);
    setPatchResult(null);
    setActiveVulnId(null);
    toast({
        title: "Patch Deployed!",
        description: "The vulnerability has been successfully mitigated."
    })
  }

  const severityBadge = (severity: Vulnerability["severity"]) => {
    switch (severity) {
      case "Critical":
        return "destructive";
      case "High":
        return "destructive";
      default:
        return "secondary";
    }
  };

  return (
    <div className="flex flex-col gap-6">
      <SectionHeading
        title="Real-Time Code Vulnerability Patching"
        description="The AI agent monitors codebases and CI/CD pipelines for vulnerabilities."
      />
      <Accordion type="single" collapsible className="w-full">
        {vulns.map((vuln) => (
          <AccordionItem value={vuln.id} key={vuln.id}>
            <AccordionTrigger className="hover:bg-muted/50 px-4 rounded-md">
              <div className="flex items-center gap-4">
                {vuln.status === 'Patched' ? <ShieldCheck className="h-5 w-5 text-green-500" /> : <AlertOctagon className="h-5 w-5 text-destructive" />}
                <div className="text-left">
                  <p className="font-semibold">{vuln.filePath}</p>
                  <p className="text-sm text-muted-foreground">{vuln.description}</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Badge variant={severityBadge(vuln.severity)}>{vuln.severity}</Badge>
                <Badge variant={vuln.status === 'Patched' ? "default" : "outline"}>{vuln.status}</Badge>
              </div>
            </AccordionTrigger>
            <AccordionContent className="p-4 space-y-4 bg-background/30">
              <div>
                <h4 className="font-semibold mb-2">Vulnerable Code</h4>
                <CodeBlock code={vuln.codeSnippet} />
              </div>
              {vuln.status !== 'Patched' && !patchResult && (
                <Button onClick={() => handleGeneratePatch(vuln)} disabled={isGenerating}>
                  {isGenerating ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Wrench className="mr-2 h-4 w-4" />}
                  {isGenerating ? "AI is Generating Patch..." : "Generate AI Patch"}
                </Button>
              )}
              {patchResult && (
                <div className="space-y-4 rounded-lg border border-primary/30 bg-primary/10 p-4">
                   <h4 className="font-semibold flex items-center gap-2"><Sparkles className="h-4 w-4 text-primary"/>AI-Generated Patch</h4>
                   <CodeBlock code={patchResult.patchCode} />
                   <div>
                       <h5 className="font-semibold text-sm mb-1">Test Result</h5>
                       <p className="text-sm text-muted-foreground">{patchResult.testResult}</p>
                   </div>
                   <Button onClick={() => handleReviewPatch(vuln)}>
                        <ShieldQuestion className="mr-2 h-4 w-4"/>
                        Review & Deploy Patch
                    </Button>
                </div>
              )}
            </AccordionContent>
          </AccordionItem>
        ))}
      </Accordion>

      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent className="sm:max-w-lg">
            <DialogHeader>
                <DialogTitle>AI Patch Safety Review</DialogTitle>
                <DialogDescription>The agent has evaluated the generated patch for potential side effects and correctness.</DialogDescription>
            </DialogHeader>
             {isReasoning && (
             <div className="flex items-center justify-center py-12">
              <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
              <p className="ml-4 text-muted-foreground">Agent is reviewing patch...</p>
            </div>
          )}
          {reasoningResult && (
              <div className="space-y-4 py-4">
                <div className="flex items-center gap-4 rounded-lg border p-4">
                    {reasoningResult.isPatchSafe ? <ShieldCheck className="h-8 w-8 text-green-500" /> : <AlertOctagon className="h-8 w-8 text-destructive" />}
                    <div>
                        <h4 className="font-bold">{reasoningResult.isPatchSafe ? "Patch Deemed Safe" : "Patch Unsafe"}</h4>
                        <p className="text-sm text-muted-foreground">The agent recommends proceeding with deployment.</p>
                    </div>
                </div>
                <div>
                  <h3 className="font-semibold mb-2">Agent's Reasoning</h3>
                  <p className="text-sm text-muted-foreground bg-background/50 p-3 rounded-md border">{reasoningResult.reasoning}</p>
                </div>
            </div>
          )}
            <DialogFooter>
                <Button variant="outline" onClick={() => setIsDialogOpen(false)}>Cancel</Button>
                <Button onClick={handleDeploy} disabled={isReasoning || !reasoningResult || !reasoningResult.isPatchSafe}>
                    <GitMerge className="mr-2 h-4 w-4" />
                    Deploy Patch
                </Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
